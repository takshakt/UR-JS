DECLARE
    l_json CLOB;
BEGIN
    APEX_JSON.INITIALIZE_CLOB_OUTPUT;
    APEX_JSON.OPEN_OBJECT; -- root

    FOR rec_hotel IN (
        SELECT DISTINCT UH.ID,
               LOWER(REPLACE(UH.HOTEL_NAME,' ','')) AS hotel_key,
               UH.HOTEL_NAME
          FROM UR_HOTELS UH
         WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
    ) LOOP
        -- "hotelname" object
        APEX_JSON.OPEN_OBJECT(rec_hotel.hotel_key);

        -- hotel name
        APEX_JSON.WRITE('name', rec_hotel.HOTEL_NAME);

        -- templates object
        APEX_JSON.OPEN_OBJECT('templates');

                -- write each template array
                FOR rec_tpl IN (
                    SELECT UT.ID, UT.DEFINITION, UT.NAME
                      FROM UR_TEMPLATES UT
                     WHERE UT.HOTEL_ID = rec_hotel.ID
                     and UT.active = 'Y'
                     and UT.ID in (select TEMPLATE_ID FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and HOTEL_ID = rec_hotel.ID )
                       --AND UPPER(UT.DEFINITION) LIKE '%'||(select NAME FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and TEMPLATE_ID  = UT.ID)||'%'
                ) LOOP
                   APEX_JSON.OPEN_ARRAY(rec_tpl.NAME);

                            FOR rec_col IN (
                                SELECT jt."name" AS col_name
                                  FROM JSON_TABLE(rec_tpl.DEFINITION, '$[*]'
                                        COLUMNS ("name" VARCHAR2(200) PATH '$.name')) jt
                            ) LOOP
                                APEX_JSON.WRITE(rec_col.col_name);
                            END LOOP;
                    APEX_JSON.CLOSE_ARRAY;
                 END LOOP; 


        APEX_JSON.OPEN_ARRAY('Global_Attributes');
        FOR rec_attr IN (
            SELECT id, name
              FROM ur_algo_attributes
             WHERE hotel_id = rec_hotel.id
               AND type = 'C'
             ORDER BY id DESC
        ) LOOP
            APEX_JSON.OPEN_OBJECT;
            APEX_JSON.WRITE('id', rec_attr.id);
            APEX_JSON.WRITE('name', rec_attr.name);
            APEX_JSON.CLOSE_OBJECT;
        END LOOP;
        APEX_JSON.CLOSE_ARRAY; -- Global_Attributes
      
        --  APEX_JSON.OPEN_ARRAY('Global_Attributes');
        -- FOR rec_algo IN (

        --               SELECT   name AS Global_Attributes
        --       FROM ur_algo_attributes
        --      WHERE hotel_id = rec_hotel.id
        --        AND type = 'C'  
        -- ) LOOP
        --     APEX_JSON.WRITE(rec_algo.Global_Attributes);
        -- END LOOP;
        -- APEX_JSON.CLOSE_ARRAY; -- Global_Attributes

/*
        APEX_JSON.OPEN_ARRAY('Strategies');
        FOR rec_algo IN (
            SELECT DISTINCT REPLACE(a.name, ' ', '_') || '(Strategy_Column)' AS EVALUATED_PRICE
              FROM (
                      SELECT id, name
                        FROM ur_algos
                       WHERE hotel_id = rec_hotel.id
                       ORDER BY id DESC
                   ) a
                   --,TABLE(ALGO_EVALUATOR_PKG.EVALUATE(a.id, NULL)) t
        ) LOOP
            APEX_JSON.WRITE(rec_algo.EVALUATED_PRICE);
        END LOOP;
        APEX_JSON.CLOSE_ARRAY; -- Strategies

        APEX_JSON.OPEN_ARRAY('Global_Attributes');
        FOR rec_attr IN (
            SELECT id, name
              FROM ur_algo_attributes
             WHERE hotel_id = rec_hotel.id
               AND type = 'C'
             ORDER BY id DESC
        ) LOOP
            APEX_JSON.OPEN_OBJECT;
            APEX_JSON.WRITE('id', rec_attr.id);
            APEX_JSON.WRITE('name', rec_attr.name);
            APEX_JSON.CLOSE_OBJECT;
        END LOOP;
        APEX_JSON.CLOSE_ARRAY; -- Global_Attributes

        -- APEX_JSON.OPEN_ARRAY('OCCUPANCY');
        -- FOR rec_algo IN (
        --     SELECT DISTINCT REPLACE(a.OCCUPANCY, ' ', '_') || '(Occupancy_Column)' AS HOTEL_OCCUPANCY
        --       FROM (
        --             SELECT DISTINCT OCCUPANCY
        --   FROM UR_HOTELS UH
        --  WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
        --            ) a
        --            --,TABLE(ALGO_EVALUATOR_PKG.EVALUATE(a.id, NULL)) t
        -- ) LOOP
        --     APEX_JSON.WRITE(rec_algo.HOTEL_OCCUPANCY);
        -- END LOOP;
        -- APEX_JSON.CLOSE_ARRAY; -- OCCUPANCY 
      

    APEX_JSON.OPEN_ARRAY('Price_Override');
        FOR rec_algo IN (

                     select distinct REPLACE(TYPE, ' ', '_')  as Price_Override from UR_HOTEL_PRICE_OVERRIDE where HOTEL_ID =rec_hotel.id and status = 'A'
        ) LOOP
            APEX_JSON.WRITE(rec_algo.Price_Override);
        END LOOP;
        APEX_JSON.CLOSE_ARRAY; -- Price_Override

        -- Hotel Occupancy (single value from UR_HOTELS)
        APEX_JSON.OPEN_ARRAY('Hotel_Occupancy');
        APEX_JSON.WRITE('OCCUPANCY');
        APEX_JSON.CLOSE_ARRAY; -- Hotel_Occupancy
*/

        APEX_JSON.CLOSE_OBJECT; -- templates 

        APEX_JSON.CLOSE_OBJECT; -- hotel 
    END LOOP;

    APEX_JSON.CLOSE_OBJECT; -- root 

    l_json := APEX_JSON.GET_CLOB_OUTPUT;
    APEX_JSON.FREE_OUTPUT;

    HTP.P(l_json);

EXCEPTION
    WHEN OTHERS THEN
        -- âœ… Always return valid JSON for errors
        APEX_JSON.INITIALIZE_CLOB_OUTPUT;
        APEX_JSON.OPEN_OBJECT;
        APEX_JSON.WRITE('error', SQLERRM);
        APEX_JSON.CLOSE_OBJECT;
        HTP.P(APEX_JSON.GET_CLOB_OUTPUT);
        APEX_JSON.FREE_OUTPUT;
END;