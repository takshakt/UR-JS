DECLARE
    l_hotel_id VARCHAR2(255) := apex_application.g_x01;
BEGIN
    INSERT INTO debug_log(message) VALUES('--- GET_LOV_DATA for hotel_id: ' || l_hotel_id);
    
    apex_json.initialize_clob_output;
    apex_json.open_object; -- Start the main JSON object

    -- Fetch Attributes as {id, name} pairs
    apex_json.open_array('attributes');
    FOR rec IN (
        -- MODIFICATION: Select the ID from the attributes table
        SELECT
            a.id,
            a.name || ' (' || (SELECT name FROM ur_templates WHERE id = a.template_id) || '||' || a.ATTRIBUTE_QUALIFIER || ')' AS name
        FROM
            ur_algo_attributes a, ur_templates t
        WHERE
            a.hotel_id = l_hotel_id
            and a.template_id = t.id
            and t.active = 'Y'
        ORDER BY
            name
    ) LOOP
        -- MODIFICATION: Write an object instead of a string for each record
        apex_json.open_object;
        apex_json.write('id', rec.id);
        apex_json.write('name', rec.name);
        apex_json.close_object;
    END LOOP;
    apex_json.close_array;

    -- Fetch Property Types as {id, name} pairs
    apex_json.open_array('propertyTypes');
    FOR rec IN (
        -- MODIFICATION: Select the ID from the templates table
        SELECT
            id,
            name
        FROM
            ur_templates
        WHERE
            hotel_id = l_hotel_id
            AND type = 'RST'
            and active = 'Y'
        ORDER BY
            name
    ) LOOP
        -- MODIFICATION: Write an object instead of a string
        apex_json.open_object;
        apex_json.write('id', rec.id);
        apex_json.write('name', rec.name);
        apex_json.close_object;
    END LOOP;
    apex_json.close_array;

    -- Fetch Occupancy Attributes as {id, name} pairs
    apex_json.open_array('occupancyAttributes');
    FOR rec IN (
        -- MODIFICATION: Select the ID from the attributes table
        SELECT
            a.id,
            a.name || ' (' || t.name || ')' AS name
        FROM
            ur_algo_attributes a,
            ur_templates t
        WHERE
            a.template_id = t.id
            AND a.hotel_id = l_hotel_id
            AND a.attribute_qualifier = 'OCCUPANCY'
            and t.active = 'Y'
        ORDER BY
            name
    ) LOOP
        -- MODIFICATION: Write an object instead of a string
        apex_json.open_object;
        apex_json.write('id', rec.id);
        apex_json.write('name', rec.name);
        apex_json.close_object;
    END LOOP;
    apex_json.close_array;

       -- Fetch Lead Time Attributes as {id, name} pairs
    apex_json.open_array('leadTimeAttributes');
    FOR rec IN (
        -- MODIFICATION: Select the ID from the attributes table
        SELECT
            a.id,
            a.name || ' (' || t.name || ')' AS name
        FROM
            ur_algo_attributes a,
            ur_templates t
        WHERE
            a.template_id = t.id
            AND a.hotel_id = l_hotel_id
            AND a.attribute_qualifier = 'BOOKING_DATE'
        ORDER BY
            name
    ) LOOP
        -- MODIFICATION: Write an object instead of a string
        apex_json.open_object;
        apex_json.write('id', rec.id);
        apex_json.write('name', rec.name);
        apex_json.close_object;
    END LOOP;
    apex_json.close_array;
    
    apex_json.close_object; -- Close the main JSON object

    -- Set the response header and print the generated JSON
    owa_util.mime_header('application/json', TRUE);
    htp.p(apex_json.get_clob_output);
    
    -- Free the resources used by the writer
    apex_json.free_output;

EXCEPTION
    WHEN OTHERS THEN
        -- Always free resources, even if an error occurs
        apex_json.free_output; 
        owa_util.mime_header('application/json', TRUE);
        htp.p('{"error":"Could not fetch LoV data. SQLERRM: ' || apex_escape.js_literal(sqlerrm) || '"}');
END;