---
- # ====== Application Process: SAVE_CARD_FIELD ================
  id: 11403687349560056
  identification: 
    name: SAVE_CARD_FIELD
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_id        VARCHAR2(255) := APEX_APPLICATION.G_X01;
        l_field     VARCHAR2(255) := APEX_APPLICATION.G_X02;
        l_new_value VARCHAR2(4000) := APEX_APPLICATION.G_X03;
        l_sql       VARCHAR2(4000);
      BEGIN
        IF l_id IS NULL OR l_field IS NULL THEN
          APEX_JSON.OPEN_OBJECT;
          APEX_JSON.WRITE('success', FALSE);
          APEX_JSON.WRITE('message', 'ID and Field Name cannot be null.');
          APEX_JSON.CLOSE_OBJECT;
          RETURN;
        END IF;
      
        l_sql := 'UPDATE UR_HOTELS SET "' || l_field || '" = :new_value WHERE ID = :id';
      
        EXECUTE IMMEDIATE l_sql
          USING l_new_value, l_id;
      
        COMMIT; 
      
        APEX_JSON.OPEN_OBJECT;
        APEX_JSON.WRITE('success', TRUE);
        APEX_JSON.WRITE('message', 'Update successful for ' || l_field || ' to ' || l_new_value);
        APEX_JSON.CLOSE_OBJECT;
      
      EXCEPTION
        WHEN OTHERS THEN
          ROLLBACK; -- Rollback on error
          APEX_JSON.OPEN_OBJECT;
          APEX_JSON.WRITE('success', FALSE);
          APEX_JSON.WRITE('message', SQLERRM);
          APEX_JSON.CLOSE_OBJECT;
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45373211511323

- # ====== Application Process: GET_BLOB =======================
  id: 11717704187426377
  identification: 
    name: GET_BLOB
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_mime_type VARCHAR2(255);
        l_blob      BLOB;
      BEGIN
        -- Use :ID as the bind variable passed via URL (ensure :ID matches datatype)
        SELECT IMG_TYPE, IMAGE 
          INTO l_mime_type, l_blob
          FROM UR_HOTELS
         WHERE ID = :ID;  -- Keep :ID as is (NUMBER or VARCHAR2 depending on your table)
      
        owa_util.mime_header(l_mime_type, FALSE);
        htp.p('Content-length: ' || DBMS_LOB.getlength(l_blob));
        owa_util.http_header_close;
        wpg_docload.download_file(l_blob);
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          htp.p('No image found');
        WHEN OTHERS THEN
          htp.p('Error: ' || SQLERRM);
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45373320787877

- # ====== Application Process: AJX_GET_REPORT_HOTEL ===========
  id: 12853541223808182
  identification: 
    name: AJX_GET_REPORT_HOTEL
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      BEGIN
        APEX_JSON.OPEN_ARRAY;
        IF apex_application.g_x01 = 'HOTEL' THEN
            FOR rec IN (SELECT ID, HOTEL_NAME FROM UR_HOTELS order by upper(hotel_name)) LOOP
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('ID', rec.ID);
              APEX_JSON.WRITE('HOTEL_NAME', rec.HOTEL_NAME);
              APEX_JSON.CLOSE_OBJECT;
            END LOOP;
        ELSIF  apex_application.g_x01 = 'REPORT_DETAIL' THEN
           FOR rec IN (SELECT ID, NAME, DEFINITION,DEFINITION_JSON,DB_OBJECT_NAME, COLUMN_ALIAS,EXPRESSIONS_CLOB FROM TEMP_UR_REPORTS 
          WHERE ID = apex_application.g_x02
          ) LOOP
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('ID', rec.ID);
              APEX_JSON.WRITE('REPORT_NAME', rec.NAME);
              APEX_JSON.WRITE('DEFINITION', rec.DEFINITION);
              APEX_JSON.WRITE('DB_OBJECT_NAME', rec.DB_OBJECT_NAME);
              APEX_JSON.WRITE('DEFINITION_JSON', rec.DEFINITION_JSON);
              APEX_JSON.WRITE('COLUMN_ALIAS', rec.COLUMN_ALIAS);
              APEX_JSON.WRITE('EXPRESSIONS_CLOB', rec.EXPRESSIONS_CLOB);
              APEX_JSON.CLOSE_OBJECT;
              END LOOP;
        ELSE
          FOR rec IN (SELECT ID, NAME, DEFINITION FROM TEMP_UR_REPORTS 
          WHERE HOTEL_ID = apex_application.g_x02
          ) LOOP
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('ID', rec.ID);
              APEX_JSON.WRITE('REPORT_NAME', rec.NAME);
              APEX_JSON.WRITE('DEFINITION', rec.DEFINITION); 
              APEX_JSON.CLOSE_OBJECT;
              END LOOP;
        END IF;
        APEX_JSON.CLOSE_ARRAY;
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45693613916325

- # ====== Application Process: AJX_GET_HOTEL_TEMPLATES ========
  id: 12856996721950922
  identification: 
    name: AJX_GET_HOTEL_TEMPLATES
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
          l_json CLOB;
      BEGIN
          APEX_JSON.INITIALIZE_CLOB_OUTPUT;
          APEX_JSON.OPEN_OBJECT; -- root
      
          FOR rec_hotel IN (
              SELECT DISTINCT UH.ID,
                     LOWER(REPLACE(UH.HOTEL_NAME,' ','')) AS hotel_key,
                     UH.HOTEL_NAME
                FROM UR_HOTELS UH
               WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
          ) LOOP
              -- "hotelname" object
              APEX_JSON.OPEN_OBJECT(rec_hotel.hotel_key);
      
              -- hotel name
              APEX_JSON.WRITE('name', rec_hotel.HOTEL_NAME);
      
              -- templates object
              APEX_JSON.OPEN_OBJECT('templates');
      
              -- write each template array
              FOR rec_tpl IN (
                  SELECT UT.ID, UT.DEFINITION, UT.NAME
                    FROM UR_TEMPLATES UT
                   WHERE UT.HOTEL_ID = rec_hotel.ID
                   and UT.active = 'Y'
                   and UT.ID in (select TEMPLATE_ID FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and HOTEL_ID = rec_hotel.ID )
                     --AND UPPER(UT.DEFINITION) LIKE '%'||(select NAME FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and TEMPLATE_ID  = UT.ID)||'%'
              ) LOOP
                 APEX_JSON.OPEN_ARRAY(rec_tpl.NAME);
      
                  FOR rec_col IN (
                      SELECT jt."name" AS col_name
                        FROM JSON_TABLE(rec_tpl.DEFINITION, '$[*]'
                              COLUMNS ("name" VARCHAR2(200) PATH '$.name')) jt
                  ) LOOP
                      APEX_JSON.WRITE(rec_col.col_name);
                  END LOOP;
                  APEX_JSON.CLOSE_ARRAY;
              END LOOP;
      
      
              APEX_JSON.OPEN_ARRAY('Strategies');
              FOR rec_algo IN (
                  SELECT DISTINCT REPLACE(a.name, ' ', '_') || '(Strategy_Column)' AS EVALUATED_PRICE
                    FROM (
                            SELECT id, name
                              FROM ur_algos
                             WHERE hotel_id = rec_hotel.id
                             ORDER BY id DESC
                         ) a
                         --,TABLE(ALGO_EVALUATOR_PKG.EVALUATE(a.id, NULL)) t
              ) LOOP
                  APEX_JSON.WRITE(rec_algo.EVALUATED_PRICE);
              END LOOP;
              APEX_JSON.CLOSE_ARRAY; -- Strategies 
      
              -- APEX_JSON.OPEN_ARRAY('OCCUPANCY');
              -- FOR rec_algo IN (
              --     SELECT DISTINCT REPLACE(a.OCCUPANCY, ' ', '_') || '(Occupancy_Column)' AS HOTEL_OCCUPANCY
              --       FROM (
              --             SELECT DISTINCT OCCUPANCY
              --   FROM UR_HOTELS UH
              --  WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
              --            ) a
              --            --,TABLE(ALGO_EVALUATOR_PKG.EVALUATE(a.id, NULL)) t
              -- ) LOOP
              --     APEX_JSON.WRITE(rec_algo.HOTEL_OCCUPANCY);
              -- END LOOP;
              -- APEX_JSON.CLOSE_ARRAY; -- OCCUPANCY 
            
      
          APEX_JSON.OPEN_ARRAY('Price_Override');
              FOR rec_algo IN (
      
                           select distinct REPLACE(TYPE, ' ', '_')  as Price_Override from UR_HOTEL_PRICE_OVERRIDE where HOTEL_ID =rec_hotel.id and status = 'A'
              ) LOOP
                  APEX_JSON.WRITE(rec_algo.Price_Override);
              END LOOP;
              APEX_JSON.CLOSE_ARRAY; -- Price_Override
      
              -- Hotel Occupancy (single value from UR_HOTELS)
              APEX_JSON.OPEN_ARRAY('Hotel_Occupancy');
              APEX_JSON.WRITE('OCCUPANCY');
              APEX_JSON.CLOSE_ARRAY; -- Hotel_Occupancy
      
      
              APEX_JSON.CLOSE_OBJECT; -- templates 
      
              APEX_JSON.CLOSE_OBJECT; -- hotel 
          END LOOP;
      
          APEX_JSON.CLOSE_OBJECT; -- root 
      
          l_json := APEX_JSON.GET_CLOB_OUTPUT;
          APEX_JSON.FREE_OUTPUT;
      
          HTP.P(l_json);
      
      EXCEPTION
          WHEN OTHERS THEN
              -- âœ… Always return valid JSON for errors
              APEX_JSON.INITIALIZE_CLOB_OUTPUT;
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('error', SQLERRM);
              APEX_JSON.CLOSE_OBJECT;
              HTP.P(APEX_JSON.GET_CLOB_OUTPUT);
              APEX_JSON.FREE_OUTPUT;
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45851681016562

- # ====== Application Process: AJX_GET_HOTEL_TEMP_ALL =========
  id: 12953111970538217
  identification: 
    name: AJX_GET_HOTEL_TEMP_ALL
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_clob CLOB;
      BEGIN
        APEX_JSON.INITIALIZE_CLOB_OUTPUT;
      
        -- Start JSON array
        APEX_JSON.OPEN_ARRAY;
      
        FOR rec IN (
          SELECT UT.ID,
                 UT.HOTEL_ID,
                 UT.DB_OBJECT_NAME,
                 UT.NAME AS TEMP_NAME,
                 UH.HOTEL_NAME
            FROM UR_TEMPLATES UT
            JOIN UR_HOTELS UH ON UH.ID = UT.HOTEL_ID
           WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
           --AND UPPER(UT.DEFINITION) like '%STAY_DATE%'
           -- and UT.ID in (select TEMPLATE_ID FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and HOTEL_ID = rec_hotel.ID )
             AND UPPER(UT.DEFINITION) LIKE '%'||(select NAME FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and TEMPLATE_ID  = UT.ID)||'%'
        ) LOOP
          APEX_JSON.OPEN_OBJECT;
          APEX_JSON.WRITE('id', rec.id);
          APEX_JSON.WRITE('hotel_id', rec.hotel_id);
          APEX_JSON.WRITE('db_object_name', rec.db_object_name);
          APEX_JSON.WRITE('temp_name', rec.temp_name);
          APEX_JSON.WRITE('hotel_name', rec.hotel_name);
          APEX_JSON.CLOSE_OBJECT;
        END LOOP;
      
        -- Add Hotel_Occupancy metadata entry
        FOR rec_hotel IN (
          SELECT UH.ID AS hotel_id, UH.HOTEL_NAME
            FROM UR_HOTELS UH
           WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
        ) LOOP
          APEX_JSON.OPEN_OBJECT;
          APEX_JSON.WRITE('id', rec_hotel.hotel_id);
          APEX_JSON.WRITE('hotel_id', rec_hotel.hotel_id);
          APEX_JSON.WRITE('db_object_name', 'UR_HOTELS');
          APEX_JSON.WRITE('temp_name', 'Hotel_Occupancy');
          APEX_JSON.WRITE('hotel_name', rec_hotel.hotel_name);
          APEX_JSON.CLOSE_OBJECT;
        END LOOP;
      
        -- End JSON array
        APEX_JSON.CLOSE_ARRAY;
      
        l_clob := APEX_JSON.GET_CLOB_OUTPUT;
        APEX_JSON.FREE_OUTPUT;
      
        HTP.P(l_clob);
      
      EXCEPTION
        WHEN OTHERS THEN
          HTP.P('{"error": "' || SQLERRM || '"}');
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45851681196202

- # ====== Application Process: AJX_MANAGE_REPORT_VIEW =========
  id: 13074446782408611
  identification: 
    name: AJX_MANAGE_REPORT_VIEW
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_clob CLOB;
        l_status   VARCHAR2(10);
        l_message  CLOB;
        l_icon     VARCHAR2(50);
        l_title    VARCHAR2(100);
        l_payload  CLOB;
        l_view_name VARCHAR2(20000);
        l_report_id VARCHAR2(20000);
      BEGIN
        APEX_JSON.INITIALIZE_CLOB_OUTPUT;
        APEX_JSON.OPEN_ARRAY;
        APEX_JSON.OPEN_OBJECT;
      IF apex_application.g_x01 = 'DELETE' THEN
              SELECT DB_OBJECT_NAME INTO l_view_name FROM TEMP_UR_REPORTS WHERE ID = apex_application.g_x02;
              APEX_JSON.WRITE('STATUS', 'SUCCESS');
                      APEX_JSON.WRITE('VIEW_NAME', 'TEMP_RPT1_V');
              APEX_JSON.WRITE('l_message', l_view_name);
              delete from TEMP_UR_REPORTS WHERE ID = apex_application.g_x02;
              EXECUTE IMMEDIATE ' Drop view '||l_view_name||' ' ;
      
      ELSIF apex_application.g_x01 = 'UPDATE_ALIAS' THEN     
                    APEX_JSON.WRITE('STATUS', 'SUCCESS');
                          MERGE INTO TEMP_UR_REPORTS T
                  USING (
                    SELECT apex_application.g_x02 AS HOTEL_ID,
                           apex_application.g_x03 AS REPORT_NAME ,
                           TO_CHAR(apex_application.g_x04) AS COLUMN_ALIAS
                    FROM DUAL
                  ) S
                  ON (T.name = S.REPORT_NAME AND T.HOTEL_ID = S.HOTEL_ID)
                  WHEN MATCHED THEN
                    UPDATE SET T.COLUMN_ALIAS = S.COLUMN_ALIAS ;
      
                    APEX_JSON.WRITE('l_message', 'DATA UPDATED');
      
      
      ELSIF apex_application.g_x01 = 'UPDATE_EXPRESSION' THEN     
                    APEX_JSON.WRITE('STATUS', 'SUCCESS');
                          MERGE INTO TEMP_UR_REPORTS T
                  USING (
                    SELECT apex_application.g_x02 AS HOTEL_ID,
                           apex_application.g_x03 AS REPORT_NAME ,
                           TO_CHAR(apex_application.g_x04) AS EXPRESSIONS_CLOB
                    FROM DUAL
                  ) S
                  ON (T.name = S.REPORT_NAME AND T.HOTEL_ID = S.HOTEL_ID)
                  WHEN MATCHED THEN
                    UPDATE SET T.EXPRESSIONS_CLOB = S.EXPRESSIONS_CLOB ;
      
                    APEX_JSON.WRITE('l_message', 'DATA UPDATED');
      
      ELSE
      
                    l_payload := apex_application.g_x04;
          SELECT 'TEMP_'||REPLACE(REGEXP_REPLACE(HOTEL_NAME, '[^A-Za-z0-9_]', ''), ' ', '_')||'_'||apex_application.g_x04||'_V' INTO l_view_name FROM UR_HOTELS WHERE ID = apex_application.g_x03;
          EXECUTE IMMEDIATE ' CREATE OR REPLACE VIEW '||l_view_name||' AS '||apex_application.g_x01||'  ';
              
              APEX_JSON.WRITE('STATUS', 'SUCCESS');
              APEX_JSON.WRITE('VIEW_NAME', 'TEMP_RPT1_V'); 
              MERGE INTO TEMP_UR_REPORTS T
      USING (
        SELECT apex_application.g_x03 AS HOTEL_ID,
               apex_application.g_x04 AS REPORT_NAME,   
               TO_CHAR(apex_application.g_x02) AS DEFINITION,
               l_view_name AS DB_OBJECT_NAME,
               TO_CHAR(apex_application.g_x05) AS DEFINITION_JSON
        FROM DUAL
      ) S
      ON (T.name = S.REPORT_NAME AND T.HOTEL_ID = S.HOTEL_ID)
      WHEN MATCHED THEN
        UPDATE SET T.DEFINITION     = S.DEFINITION,
                   T.DB_OBJECT_NAME = S.DB_OBJECT_NAME,
                   T.DEFINITION_JSON = S.DEFINITION_JSON
      WHEN NOT MATCHED THEN
        INSERT (HOTEL_ID, name, DEFINITION, DB_OBJECT_NAME,DEFINITION_JSON,COLUMN_ALIAS, EXPRESSIONS_CLOB)
        VALUES (S.HOTEL_ID, S.REPORT_NAME, S.DEFINITION, S.DB_OBJECT_NAME,S.DEFINITION_JSON,S.DEFINITION_JSON 
        , '{"columnConfiguration": {"hotel": null,"template": null,"selectedColumns": []},"columnMetadata": [],"formulas": {},"filters": {},"conditionalFormatting": {}}' );
      
              SELECT ID INTO l_report_id FROM TEMP_UR_REPORTS WHERE name = apex_application.g_x04 AND HOTEL_ID = apex_application.g_x03;
      
        
          APEX_JSON.WRITE('l_message', l_view_name);
          APEX_JSON.WRITE('l_report_id', l_report_id);
      END IF;
      
         APEX_JSON.CLOSE_OBJECT;
         
        -- End JSON array
        APEX_JSON.CLOSE_ARRAY;
      
        l_clob := APEX_JSON.GET_CLOB_OUTPUT;
        APEX_JSON.FREE_OUTPUT;
      
        HTP.P(l_clob);
        
      EXCEPTION
        WHEN OTHERS THEN
          HTP.P('{"error": "' || SQLERRM || '"}');
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45648374462989

- # ====== Application Process: AJX_GET_TEMP_COL_DETAILS =======
  id: 13474710824262164
  identification: 
    name: AJX_GET_TEMP_COL_DETAILS
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
          l_json CLOB;
      BEGIN
          APEX_JSON.INITIALIZE_CLOB_OUTPUT;
      
          APEX_JSON.OPEN_OBJECT; -- hotelData root
      
          FOR rec_hotel IN (
              SELECT DISTINCT UH.ID, LOWER(REPLACE(UH.HOTEL_NAME,' ','')) AS hotel_key, UH.HOTEL_NAME
              FROM UR_HOTELS UH
              WHERE upper(UH.HOTEL_NAME) = upper(apex_application.g_x01)  -- <-- value from JS
          ) LOOP
              APEX_JSON.OPEN_OBJECT(rec_hotel.hotel_key); -- hotel key like "hilton"
      
              APEX_JSON.WRITE('name', rec_hotel.HOTEL_NAME);
             APEX_JSON.OPEN_OBJECT('templates');
      
              FOR rec_tpl IN (
                  SELECT UT.ID, UT.DEFINITION, UT.NAME
                  FROM UR_TEMPLATES UT
                  WHERE UT.HOTEL_ID = rec_hotel.ID 
                 -- AND UPPER(UT.DEFINITION) like '%"NAME":"STAY_DATE"%'
                 -- and UT.ID in (select TEMPLATE_ID FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and HOTEL_ID = rec_hotel.ID )
                  AND UPPER(UT.DEFINITION) LIKE '%'||(select NAME FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and TEMPLATE_ID  = UT.ID)||'%'
              ) LOOP
                  -- Use template name as key
                  APEX_JSON.OPEN_ARRAY(rec_tpl.NAME);
                 -- APEX_JSON.WRITE('DB_OBJECT_NAME',rec_tpl.DB_OBJECT_NAME);
                 /** FOR rec_col IN (
                      SELECT jt."name" AS col_name
                      FROM JSON_TABLE(rec_tpl.DEFINITION, '$[*]'
                           COLUMNS ("name" VARCHAR2(200) PATH '$.name')) jt
                  ) LOOP
                      APEX_JSON.WRITE(rec_col.col_name);
                  END LOOP;
                  */
                  FOR rec_col IN (
                      SELECT 
                          jt."name" AS col_name,
                          jt."data_type" AS data_type
                      FROM JSON_TABLE(
                          rec_tpl.DEFINITION, '$[*]'
                          COLUMNS (
                              "name"      VARCHAR2(200) PATH '$.name',
                              "data_type" VARCHAR2(200) PATH '$.data_type'
                          )
                      ) jt
                  ) LOOP
                      APEX_JSON.WRITE(rec_col.col_name || '#' || rec_col.data_type||'#');
                  END LOOP;
                  APEX_JSON.CLOSE_ARRAY;
              END LOOP;
      
              APEX_JSON.CLOSE_OBJECT; -- templates 
              
      
              APEX_JSON.CLOSE_OBJECT; -- hotel
          END LOOP;
      
          APEX_JSON.CLOSE_OBJECT; -- hotelData
      
          l_json := APEX_JSON.GET_CLOB_OUTPUT;
          APEX_JSON.FREE_OUTPUT;
      
          -- Return JSON to JS
          HTP.P(l_json);
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45648463149361

- # ====== Application Process: AJX_GET_REPORT_DATA ============
  id: 13515514348470830
  identification: 
    name: AJX_GET_REPORT_DATA
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
          l_columns   APEX_JSON.t_values;
          l_aliases   APEX_JSON.t_values;
          l_sql       VARCHAR2(32767);
          l_cursor    INTEGER;
          l_desc      DBMS_SQL.DESC_TAB2;
          l_col_cnt   INTEGER;
          l_val_vc    VARCHAR2(4000);
          l_col_name  VARCHAR2(4000);
          l_dummy     INTEGER;
          l_name      VARCHAR2(4000);
          l_alias     VARCHAR2(4000);
      BEGIN
      
      IF apex_application.g_x01 = 'TEMPLATE_REPORT_DATA' THEN
      
      APEX_JSON.parse(l_columns, apex_application.g_x02);
      
          -- Build SELECT list
          l_sql := 'SELECT ';
          FOR i IN 1 .. APEX_JSON.get_count(p_path => '.', p_values => l_columns) LOOP
              IF i > 1 THEN
                  l_sql := l_sql || ', ';
              END IF;
              l_sql := l_sql || '"' || APEX_JSON.get_varchar2(p_path => '['||i||'].name', p_values => l_columns) || '"';
          END LOOP;
          --l_sql := l_sql || ' FROM '||apex_application.g_x03||' where rownum <= 10';
          l_sql := l_sql || ' FROM '||apex_application.g_x03||' FETCH FIRST 10 ROWS ONLY';
        --  l_sql := l_sql || ' FROM '||apex_application.g_x03||'';
      
          -- Prepare and describe
          l_cursor := DBMS_SQL.open_cursor;
          DBMS_SQL.parse(l_cursor, l_sql, DBMS_SQL.native);
          DBMS_SQL.describe_columns2(l_cursor, l_col_cnt, l_desc);
      
          -- Define all columns as varchar2
          FOR i IN 1 .. l_col_cnt LOOP
              DBMS_SQL.define_column(l_cursor, i, l_val_vc, 4000);
          END LOOP;
      
          
          l_dummy := DBMS_SQL.execute(l_cursor);
      
          -- Output JSON
          APEX_JSON.open_object;
          APEX_JSON.open_array('rows');
      
          WHILE DBMS_SQL.fetch_rows(l_cursor) > 0 LOOP
              APEX_JSON.open_object;
              FOR i IN 1 .. l_col_cnt LOOP
                  l_col_name := l_desc(i).col_name;
                  DBMS_SQL.column_value(l_cursor, i, l_val_vc);
                   IF l_val_vc IS NULL THEN
                   --   DBMS_OUTPUT.put_line(l_col_name || ' = NULL');
                      APEX_JSON.write(l_col_name,  ' ');
                  ELSE
                     -- DBMS_OUTPUT.put_line(l_col_name || ' = ' || l_val_vc);
                      APEX_JSON.write(l_col_name, l_val_vc);
                  END IF;
                  
              END LOOP;
              APEX_JSON.close_object;
          END LOOP;
      
          APEX_JSON.close_array;
          APEX_JSON.close_object;
      
          DBMS_SQL.close_cursor(l_cursor);
      
      ELSE
          -- Parse incoming JSON
          APEX_JSON.parse(l_columns, apex_application.g_x01); -- columns_list
          APEX_JSON.parse(l_aliases, apex_application.g_x02); -- col_alias
      
          -- Build SELECT list
          l_sql := 'SELECT ';
          FOR i IN 1 .. APEX_JSON.get_count(p_path => '.', p_values => l_columns) LOOP
              IF i > 1 THEN
                  l_sql := l_sql || ', ';
              END IF;
      
              -- column name (e.g. BOOKING_ID - VK Sample Hotel Data)
              l_name := APEX_JSON.get_varchar2(p_path => '['||i||'].name', p_values => l_columns);
      
              -- find matching alias_name from col_alias
              SELECT MAX(alias_name)
              INTO l_alias
              FROM JSON_TABLE(apex_application.g_x02, '$.selectedColumns[*]'
                    COLUMNS (
                      col_name   VARCHAR2(200) PATH '$.col_name',
                      temp_name  VARCHAR2(200) PATH '$.temp_name',
                      alias_name VARCHAR2(200) PATH '$.alias_name'
                    ))
              WHERE col_name || ' - ' || temp_name = l_name;
      
              -- fallback if no alias found
              IF l_alias IS NULL THEN
                  l_alias := l_name;
              END IF;
      
              -- add to SQL
             -- l_sql := l_sql || '"' || l_name || '" AS "' || l_alias || '"';
      		l_sql := l_sql || '"' || l_name || '"' || ' AS "' || REPLACE(l_alias,'"') || '"';
      
          END LOOP;
      
          l_sql := l_sql || ' FROM '||apex_application.g_x03;  -- pass db object name separately
      	
      
          -- Prepare, describe, execute
          l_cursor := DBMS_SQL.open_cursor;
          DBMS_SQL.parse(l_cursor, l_sql, DBMS_SQL.native);
          DBMS_SQL.describe_columns2(l_cursor, l_col_cnt, l_desc);
      
          FOR i IN 1 .. l_col_cnt LOOP
              DBMS_SQL.define_column(l_cursor, i, l_val_vc, 4000);
          END LOOP;
      
          l_dummy := DBMS_SQL.execute(l_cursor);
      
          -- Output JSON
          APEX_JSON.open_object;
          APEX_JSON.open_array('rows');
      
          WHILE DBMS_SQL.fetch_rows(l_cursor) > 0 LOOP
              APEX_JSON.open_object;
              FOR i IN 1 .. l_col_cnt LOOP
                  l_col_name := l_desc(i).col_name;
                  DBMS_SQL.column_value(l_cursor, i, l_val_vc);
                  APEX_JSON.write(l_col_name, l_val_vc);
              END LOOP;
              APEX_JSON.close_object;
          END LOOP;
      
          APEX_JSON.close_array;
          APEX_JSON.close_object;
      
          DBMS_SQL.close_cursor(l_cursor);
          END IF;
      EXCEPTION
          WHEN OTHERS THEN
              IF DBMS_SQL.is_open(l_cursor) THEN
                  DBMS_SQL.close_cursor(l_cursor);
              END IF;
              RAISE;
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45693609159575

- # ====== Application Process: AJX_MANAGE_REPORT_DASHBOARD ====
  id: 13749013797549241
  identification: 
    name: AJX_MANAGE_REPORT_DASHBOARD
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_clob CLOB;
        l_status   VARCHAR2(10);
        l_message  CLOB;
        l_icon     VARCHAR2(50);
        l_title    VARCHAR2(100);
        l_payload  CLOB;
        l_view_name VARCHAR2(20000);
      BEGIN
        APEX_JSON.INITIALIZE_CLOB_OUTPUT;
        APEX_JSON.OPEN_ARRAY;
        APEX_JSON.OPEN_OBJECT;
      IF apex_application.g_x01 = 'DELETE' THEN
              SELECT DB_OBJECT_NAME INTO l_view_name FROM TEMP_UR_REPORTS WHERE ID = apex_application.g_x02;
              APEX_JSON.WRITE('STATUS', 'SUCCESS');
                      APEX_JSON.WRITE('VIEW_NAME', 'TEMP_RPT1_V');
              APEX_JSON.WRITE('l_message', l_view_name);
            --  delete from TEMP_UR_REPORTS WHERE ID = apex_application.g_x02;
          --    EXECUTE IMMEDIATE ' Drop view '||l_view_name||' ' ;
      elsif     apex_application.g_x01 = 'SELECT' THEN
              SELECT DEFINITION INTO l_payload FROM TEMP_UR_REPORT_DASHBOARDS WHERE HOTEL_ID = apex_application.g_x02;
           APEX_JSON.WRITE('STATUS', 'SUCCESS'); 
              APEX_JSON.WRITE('l_payload', l_payload);
      
      elsif     apex_application.g_x01 = 'SELECT_SUMMARY' THEN
              SELECT SUMMARY INTO l_payload FROM TEMP_UR_REPORT_DASHBOARDS WHERE HOTEL_ID = apex_application.g_x02;
           APEX_JSON.WRITE('STATUS', 'SUCCESS'); 
              APEX_JSON.WRITE('l_payload', l_payload);
      
      elsif     apex_application.g_x01 = 'INSERT_SUMMARY' THEN
                       APEX_JSON.WRITE('STATUS', 'SUCCESS');
                          MERGE INTO TEMP_UR_REPORT_DASHBOARDS T
                  USING (
                    SELECT apex_application.g_x02 AS HOTEL_ID, 
                           TO_CHAR(apex_application.g_x03) AS SUMMARY 
                    FROM DUAL
                  ) S
                  ON (T.HOTEL_ID = S.HOTEL_ID)
                  WHEN MATCHED THEN
                    UPDATE SET T.SUMMARY     = S.SUMMARY 
                  WHEN NOT MATCHED THEN
                    INSERT (HOTEL_ID,  SUMMARY )
                    VALUES (S.HOTEL_ID,   S.SUMMARY );       
      
      ELSE
      --TEMP_UR_REPORT_DASHBOARDS(HOTEL_ID , DEFINITION)
                  --  l_payload := apex_application.g_x04;
         -- SELECT 'TEMP_'||REPLACE(REGEXP_REPLACE(HOTEL_NAME, '[^A-Za-z0-9_]', ''), ' ', '_')||'_'||apex_application.g_x04||'_V' INTO l_view_name FROM UR_HOTELS WHERE ID = apex_application.g_x03;
      
              
              APEX_JSON.WRITE('STATUS', 'SUCCESS');
              MERGE INTO TEMP_UR_REPORT_DASHBOARDS T
      USING (
        SELECT apex_application.g_x02 AS HOTEL_ID, 
               TO_CHAR(apex_application.g_x03) AS DEFINITION 
        FROM DUAL
      ) S
      ON (T.HOTEL_ID = S.HOTEL_ID)
      WHEN MATCHED THEN
        UPDATE SET T.DEFINITION     = S.DEFINITION 
      WHEN NOT MATCHED THEN
        INSERT (HOTEL_ID,  DEFINITION )
        VALUES (S.HOTEL_ID,   S.DEFINITION );
      
      
         
      END IF;
      
         APEX_JSON.CLOSE_OBJECT;
         
        -- End JSON array
        APEX_JSON.CLOSE_ARRAY;
      
        l_clob := APEX_JSON.GET_CLOB_OUTPUT;
        APEX_JSON.FREE_OUTPUT;
      
        HTP.P(l_clob);
        
      EXCEPTION
        WHEN OTHERS THEN
          HTP.P('{"error": "' || SQLERRM || '"}');
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45648503739752

- # ====== Application Process: AJX_MANAGE_ALGO ================
  id: 15031571000976823
  identification: 
    name: AJX_MANAGE_ALGO
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
          l_clob      CLOB;
          l_status    VARCHAR2(20);
          l_message   CLOB;
          l_icon      VARCHAR2(50);
          l_title     VARCHAR2(100);
          l_payload   CLOB;
      BEGIN
          -- Log the start of the process and all incoming parameters
          APEX_DEBUG.MESSAGE('--- AJX_MANAGE_ALGO START ---');
          APEX_DEBUG.MESSAGE('Mode (x01): %0', apex_application.g_x01);
          APEX_DEBUG.MESSAGE('Algo ID (x02): %0', apex_application.g_x02);
          APEX_DEBUG.MESSAGE('Version ID (x03): %0', apex_application.g_x03);
      
          APEX_JSON.INITIALIZE_CLOB_OUTPUT;
          APEX_JSON.OPEN_OBJECT; -- Open a single root JSON object for the response
      
          IF apex_application.g_x01 = 'SELECT' THEN
              APEX_DEBUG.MESSAGE('Entering SELECT block...');
              BEGIN
                  -- Using an inner BEGIN...EXCEPTION...END block to catch specific errors
                  
                  -- << BUG FIX >>: The WHERE clause now correctly uses the ID column, not the VERSION column.
                  SELECT EXPRESSION
                  INTO l_payload
                  FROM UR_ALGO_VERSIONS
                  WHERE ALGO_ID = apex_application.g_x02
                    AND ID = apex_application.g_x03; -- Corrected from "version ="
      
                  APEX_DEBUG.MESSAGE('SELECT successful. Payload CLOB length: %0', DBMS_LOB.GETLENGTH(l_payload));
                  
                  -- Write success response
                  APEX_JSON.WRITE('success', true);
                  APEX_JSON.WRITE('message', 'Configuration loaded successfully.');
                  APEX_JSON.OPEN_ARRAY('data'); -- Nest the data in an array as per your original structure
                  APEX_JSON.OPEN_OBJECT;
                  APEX_JSON.WRITE('l_payload', l_payload);
                  APEX_JSON.CLOSE_OBJECT;
                  APEX_JSON.CLOSE_ARRAY;
      
              EXCEPTION
                  WHEN NO_DATA_FOUND THEN
                      APEX_DEBUG.ERROR('NO_DATA_FOUND exception for Algo ID: %0 and Version ID: %1', apex_application.g_x02, apex_application.g_x03);
                      APEX_JSON.WRITE('success', false);
                      APEX_JSON.WRITE('message', 'Error: No configuration was found for the selected algorithm and version. The query returned no rows.');
                  WHEN OTHERS THEN
                      APEX_DEBUG.ERROR('Unhandled exception in SELECT block. SQLERRM: %0', SQLERRM);
                      APEX_JSON.WRITE('success', false);
                      APEX_JSON.WRITE('message', 'An unexpected database error occurred during select: ' || SQLERRM);
              END;
      
          ELSIF apex_application.g_x01 IN ('INSERT', 'UPDATE') THEN
              -- Handle INSERT or UPDATE logic here if needed
              APEX_DEBUG.MESSAGE('Entering INSERT/UPDATE block...');
              -- Add your insert/update logic here if required
              APEX_JSON.WRITE('success', false);
              APEX_JSON.WRITE('message', 'Operation ' || apex_application.g_x01 || ' is not yet implemented.');
              
          ELSE
              APEX_DEBUG.WARN('Invalid mode passed: %0', apex_application.g_x01);
              APEX_JSON.WRITE('success', false);
              APEX_JSON.WRITE('message', 'Invalid operation specified.');
          END IF;
      
          APEX_JSON.CLOSE_OBJECT; -- Close the root JSON object
          l_clob := APEX_JSON.GET_CLOB_OUTPUT;
          APEX_JSON.FREE_OUTPUT;
          
          APEX_DEBUG.MESSAGE('--- AJX_MANAGE_ALGO END ---');
          HTP.P(l_clob);
      
      EXCEPTION
          WHEN OTHERS THEN
              -- This is a critical failure handler. It catches errors in the main block structure.
              APEX_DEBUG.ERROR(
                  'CRITICAL UNHANDLED EXCEPTION in AJX_MANAGE_ALGO. SQLERRM: %0. Backtrace: %1',
                  SQLERRM,
                  DBMS_UTILITY.FORMAT_ERROR_BACKTRACE
              );
              -- Ensure a valid JSON error is returned
              APEX_JSON.INITIALIZE_CLOB_OUTPUT;
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('success', false);
              APEX_JSON.WRITE('message', 'A critical server error occurred: ' || SQLERRM);
              APEX_JSON.CLOSE_OBJECT;
              HTP.P(APEX_JSON.GET_CLOB_OUTPUT);
              APEX_JSON.FREE_OUTPUT;
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45527205687069

- # ====== Application Process: AJX_GET_REPORT_ALL_QUALIFIERS ==
  id: 18133869080481287
  identification: 
    name: AJX_GET_REPORT_ALL_QUALIFIERS
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
          l_json CLOB;
      BEGIN
          APEX_JSON.INITIALIZE_CLOB_OUTPUT;
          APEX_JSON.OPEN_OBJECT; -- root
          APEX_JSON.OPEN_ARRAY('data'); -- array start
      
          FOR rec IN (
              SELECT NAME,
                     SUBSTR(KEY, 1, INSTR(KEY, '.') - 1) AS temp_name  
              FROM UR_ALGO_ATTRIBUTES 
              WHERE ATTRIBUTE_QUALIFIER = 'STAY_DATE' 
                AND HOTEL_ID = APEX_APPLICATION.G_X01
          ) LOOP
              APEX_JSON.OPEN_OBJECT;
              APEX_JSON.WRITE('name', rec.NAME);
              APEX_JSON.WRITE('temp_name', rec.temp_name);
              APEX_JSON.CLOSE_OBJECT;
          END LOOP;
      
          APEX_JSON.CLOSE_ARRAY; -- data
          APEX_JSON.CLOSE_OBJECT; -- root
      
          l_json := APEX_JSON.GET_CLOB_OUTPUT;
          APEX_JSON.FREE_OUTPUT;
          HTP.P(l_json);
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45648437039551

- # ====== Application Process: DOWNLOAD_FILE ==================
  id: 18364649581104687
  identification: 
    name: DOWNLOAD_FILE
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_blob   BLOB;
        l_mime   VARCHAR2(255);
        l_name   VARCHAR2(400);
      BEGIN
        SELECT blob_content, mime_type, filename
          INTO l_blob, l_mime, l_name
          FROM (
            SELECT blob_content, mime_type, filename
            FROM temp_blob
            WHERE filename = apex_application.g_x01
            ORDER BY created_on DESC
          )
         WHERE ROWNUM = 1;
      
        sys.htp.init;
        owa_util.mime_header(NVL(l_mime, 'text/plain'), FALSE);
        htp.p('Content-length: ' || dbms_lob.getlength(l_blob));
        htp.p('Content-Disposition: attachment; filename="' || l_name || '"');
        owa_util.http_header_close;
        wpg_docload.download_file(l_blob);
        apex_application.stop_apex_engine;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          htp.p('File not found.');
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45648466798130

- # ====== Application Process: AJX_GET_USR_TYPE ===============
  id: 28714487824000760
  identification: 
    name: AJX_GET_USR_TYPE
    type: NATIVE_PLSQL

  source: 
    location: Local Database
    language: PL/SQL
    pl/sql-code: |
      DECLARE
        l_user_type UR_USERS.user_type%TYPE;
        l_username  VARCHAR2(255) := APEX_APPLICATION.G_X01;
      BEGIN
        SELECT user_type
          INTO l_user_type
          FROM UR_USERS
         WHERE UPPER(user_name) = UPPER(l_username);
      
        -- Output valid JSON
        HTP.P('{"type": "' || REPLACE(l_user_type, '"', '\"') || '"}');
      
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          HTP.P('{"type": "NOT_FOUND"}');
        WHEN OTHERS THEN
          HTP.P('{"type": "ERROR", "message": "' || REPLACE(SQLERRM, '"', '\"') || '"}');
      END;

  execution: 
    sequence: 1
    point: Ajax Callback

  security: 
    authorization-scheme: Must Not Be Public User

  subscription: 
    version-number: 45851669647072

