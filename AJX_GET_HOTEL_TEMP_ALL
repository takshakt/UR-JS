DECLARE
  l_clob CLOB;
BEGIN
  APEX_JSON.INITIALIZE_CLOB_OUTPUT;

  -- Start JSON array
  APEX_JSON.OPEN_ARRAY;

  FOR rec IN (
    SELECT UT.ID,
           UT.HOTEL_ID,
           UT.DB_OBJECT_NAME,
           UT.NAME AS TEMP_NAME,
           UH.HOTEL_NAME
      FROM UR_TEMPLATES UT
      JOIN UR_HOTELS UH ON UH.ID = UT.HOTEL_ID
     WHERE UPPER(UH.HOTEL_NAME) = UPPER(apex_application.g_x01)
     --AND UPPER(UT.DEFINITION) like '%STAY_DATE%'
     -- and UT.ID in (select TEMPLATE_ID FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and HOTEL_ID = rec_hotel.ID )
       AND UPPER(UT.DEFINITION) LIKE '%'||(select NAME FROM UR_ALGO_ATTRIBUTES where ATTRIBUTE_QUALIFIER = 'STAY_DATE' and TEMPLATE_ID  = UT.ID)||'%'
  ) LOOP
    APEX_JSON.OPEN_OBJECT;
    APEX_JSON.WRITE('id', rec.id);
    APEX_JSON.WRITE('hotel_id', rec.hotel_id);
    APEX_JSON.WRITE('db_object_name', rec.db_object_name);
    APEX_JSON.WRITE('temp_name', rec.temp_name);
    APEX_JSON.WRITE('hotel_name', rec.hotel_name);
    APEX_JSON.CLOSE_OBJECT;
  END LOOP;

  -- End JSON array
  APEX_JSON.CLOSE_ARRAY;

  l_clob := APEX_JSON.GET_CLOB_OUTPUT;
  APEX_JSON.FREE_OUTPUT;

  HTP.P(l_clob);

EXCEPTION
  WHEN OTHERS THEN
    HTP.P('{"error": "' || SQLERRM || '"}');
END;